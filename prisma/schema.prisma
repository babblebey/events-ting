// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
    // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
    // Further reading:
    // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
    // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
    url      = env("DATABASE_URL")
}

model Post {
    id        Int      @id @default(autoincrement())
    name      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    createdBy   User   @relation(fields: [createdById], references: [id])
    createdById String

    @@index([name])
}

// Necessary for Next auth
model Account {
    id                       String  @id @default(cuid())
    userId                   String
    type                     String
    provider                 String
    providerAccountId        String
    refresh_token            String? // @db.Text
    access_token             String? // @db.Text
    expires_at               Int?
    token_type               String?
    scope                    String?
    id_token                 String? // @db.Text
    session_state            String?
    user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    refresh_token_expires_in Int?

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
    id            String    @id @default(cuid())
    name          String?
    email         String?   @unique
    emailVerified DateTime?
    image         String?
    password      String?
    accounts      Account[]
    sessions      Session[]
    posts         Post[]
    events        Event[] // Events created by this user (organizer)
    registrations Registration[] // Attendee registrations
    
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @default(now()) @updatedAt
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

// ============================================================================
// EVENT MANAGEMENT SYSTEM
// ============================================================================

model Event {
    id          String   @id @default(cuid())
    slug        String   @unique // URL-friendly identifier
    name        String
    description String   @db.Text
    
    // Location & Timing
    locationType    String // 'in-person' | 'virtual' | 'hybrid'
    locationAddress String? // Physical address if in-person/hybrid
    locationUrl     String? // Virtual URL if virtual/hybrid
    timezone        String   @default("UTC") // IANA timezone
    startDate       DateTime // Stored in UTC
    endDate         DateTime // Stored in UTC
    
    // Status & Visibility
    status      String   @default("draft") // 'draft' | 'published' | 'archived'
    isArchived  Boolean  @default(false) // Soft delete flag
    
    // Organizer
    organizerId String
    organizer   User     @relation(fields: [organizerId], references: [id], onDelete: Restrict)
    
    // Relations
    ticketTypes      TicketType[]
    registrations    Registration[]
    scheduleEntries  ScheduleEntry[]
    callForPapers    CallForPapers?
    speakers         Speaker[]
    emailCampaigns   EmailCampaign[]
    
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    @@index([organizerId])
    @@index([slug])
    @@index([status, isArchived])
}

model TicketType {
    id          String   @id @default(cuid())
    eventId     String
    event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
    
    name        String
    description String   @db.Text
    
    // Pricing (MVP: must be 0.00 for free tickets)
    price       Decimal  @default(0.00) @db.Decimal(10, 2)
    currency    String   @default("USD")
    
    // Availability
    quantity    Int // Total available
    saleStart   DateTime? // Nullable: no restriction if null
    saleEnd     DateTime? // Nullable: no restriction if null
    
    // Relations
    registrations Registration[]
    
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    @@index([eventId])
}

model Registration {
    id          String   @id @default(cuid())
    eventId     String
    event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
    
    ticketTypeId String
    ticketType   TicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Restrict)
    
    // Attendee Info
    email       String
    name        String
    userId      String? // Optional: link to authenticated user
    user        User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
    
    // Payment (future-ready fields)
    paymentStatus     String  @default("free") // 'free' | 'pending' | 'paid' | 'failed' | 'refunded'
    paymentIntentId   String? // Stripe/Paystack intent ID
    paymentProcessor  String? // 'stripe' | 'paystack' | null
    
    // Email Status
    emailStatus String  @default("active") // 'active' | 'bounced' | 'unsubscribed'
    
    // Custom Fields
    customData  Json?
    
    registeredAt DateTime @default(now())
    updatedAt    DateTime @updatedAt
    
    @@index([eventId])
    @@index([ticketTypeId])
    @@index([email])
    @@index([userId])
}

model ScheduleEntry {
    id          String   @id @default(cuid())
    eventId     String
    event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
    
    title       String
    description String   @db.Text
    
    // Timing (stored in UTC)
    startTime   DateTime
    endTime     DateTime
    
    // Location (room, stage, track)
    location    String?
    track       String? // Track name for multi-track conferences
    trackColor  String? // Hex color for track visual indicator
    
    // Session Type
    sessionType String? // 'keynote' | 'talk' | 'workshop' | 'break' | 'networking'
    
    // Relations
    speakerSessions SpeakerSession[]
    
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt // For optimistic concurrency control
    
    @@index([eventId])
    @@index([startTime])
}

model SpeakerSession {
    id              String        @id @default(cuid())
    scheduleEntryId String
    scheduleEntry   ScheduleEntry @relation(fields: [scheduleEntryId], references: [id], onDelete: Cascade)
    
    speakerId       String
    speaker         Speaker       @relation(fields: [speakerId], references: [id], onDelete: Cascade)
    
    role            String?       @default("speaker") // 'speaker' | 'moderator' | 'panelist'
    
    createdAt       DateTime      @default(now())
    
    @@unique([scheduleEntryId, speakerId])
    @@index([scheduleEntryId])
    @@index([speakerId])
}

model CallForPapers {
    id          String   @id @default(cuid())
    eventId     String   @unique
    event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
    
    guidelines  String   @db.Text
    deadline    DateTime
    status      String   @default("open") // 'open' | 'closed'
    
    // Required fields for submissions
    requiredFields Json?
    
    // Relations
    submissions CfpSubmission[]
    
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    @@index([status, deadline])
}

model CfpSubmission {
    id          String   @id @default(cuid())
    eventId     String
    cfpId       String
    cfp         CallForPapers @relation(fields: [cfpId], references: [id], onDelete: Cascade)
    
    // Proposal Details
    title       String
    description String   @db.Text
    sessionFormat String // 'talk' | 'workshop' | 'panel' | 'lightning'
    duration    Int // Minutes
    
    // Speaker Info
    speakerName  String
    speakerEmail String
    speakerBio   String   @db.Text
    speakerPhoto String?
    
    // Social Links
    speakerTwitter  String?
    speakerGithub   String?
    speakerLinkedin String?
    speakerWebsite  String?
    
    // Review
    status      String   @default("pending") // 'pending' | 'accepted' | 'rejected'
    reviewNotes String?  @db.Text
    reviewScore Int?
    
    // Relations
    speakerId   String?
    speaker     Speaker? @relation(fields: [speakerId], references: [id], onDelete: SetNull)
    
    submittedAt DateTime @default(now())
    reviewedAt  DateTime?
    updatedAt   DateTime @updatedAt
    
    @@index([cfpId])
    @@index([status])
    @@index([speakerEmail])
}

model Speaker {
    id          String   @id @default(cuid())
    eventId     String
    event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
    
    name        String
    bio         String   @db.Text
    email       String
    photo       String?
    
    // Social Links
    twitter     String?
    github      String?
    linkedin    String?
    website     String?
    
    // Relations
    speakerSessions SpeakerSession[]
    cfpSubmissions  CfpSubmission[]
    
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    @@index([eventId])
    @@index([email])
}

model EmailCampaign {
    id          String   @id @default(cuid())
    eventId     String
    event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
    
    subject     String
    body        String   @db.Text
    
    // Recipient Selection
    recipientType String // 'all_attendees' | 'ticket_type' | 'speakers' | 'custom'
    recipientFilter Json?
    
    // Sending
    status      String   @default("draft") // 'draft' | 'scheduled' | 'sending' | 'sent' | 'failed'
    scheduledFor DateTime?
    sentAt      DateTime?
    
    // Delivery Stats
    totalRecipients Int?
    delivered       Int      @default(0)
    bounces         Int      @default(0)
    opens           Int      @default(0)
    clicks          Int      @default(0)
    
    // Resend Integration
    resendBatchId   String?
    
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    @@index([eventId])
    @@index([status, scheduledFor])
}
